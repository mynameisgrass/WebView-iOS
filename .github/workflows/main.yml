name: Build VNMAP
on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸª„ Magic - Rename App & Change Icon
        run: |
          # 1. CHANGE APP NAME TO "VNMAP"
          # We use 'plutil' to edit the settings file directly
          PLIST="WebView-iOS/Info.plist"
          plutil -replace CFBundleDisplayName -string "VNMAP" "$PLIST"
          plutil -replace CFBundleName -string "VNMAP" "$PLIST"

          # 2. REPLACE ICON (The Smart Way)
          # This script finds the app's icon folder, looks at the size of every 
          # existing icon, and resizes YOUR icon.png to match perfectly.
          
          if [ -f "icon.png" ]; then
            echo "Found icon.png! Overwriting app icons..."
            ICON_SET=$(find . -type d -name "AppIcon.appiconset" | head -n 1)
            
            # Loop through every PNG in the icon folder
            for f in "$ICON_SET"/*.png; do
               # Get the width of the original file
               WIDTH=$(sips -g pixelWidth "$f" | tail -n1 | awk '{print $2}')
               # Resize your icon.png to that width and overwrite the file
               sips -z $WIDTH $WIDTH icon.png --out "$f"
            done
          else
            echo "WARNING: icon.png not found. Using default icon."
          fi

      - name: Build App (Unsigned)
        run: |
          # Build with the new name and icon
          xcodebuild build \
            -scheme "WebView-iOS" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            IPHONEOS_DEPLOYMENT_TARGET=13.0 \
            -derivedDataPath build

      - name: Package IPA Manually
        run: |
          mkdir Payload
          # Move the app into the Payload folder
          mv build/Build/Products/Release-iphoneos/*.app Payload/
          # Zip it into an IPA
          zip -r "VNMAP.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: VNMAP-IPA
          path: VNMAP.ipa
